/*
 * ER/Studio 8.0 SQL Code Generation
 * Company :      FIUNAM
 * Project :      1Equipo-Appsafe.DM1
 * Authors :      Alvarez Lopez Carlos Manuel
				  Membrilla Isaias I�aki Ramos
				  Miram�n P�rez Jocelyn
 *
 * Date Created : Wednesday, April 16, 2025 17:39:49

 */

USE [APPSAFE]
GO

-- TRIGGER TR_AUTO_FOR1

BEGIN TRANSACTION TEST_TR_AUTO_FOR1_CANTIDAD

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0),
        (101, 'NRVOUS01', 2025, 4, 1, 0),
        (102, 'A113PIXA', 2025, 4, 1, 1);

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_AUTO_FOR1_AÑO

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2000, 4, 1, 1);

ROLLBACK TRANSACTION

SELECT * FROM USUARIOS.AUTOMOVIL
DELETE FROM USUARIOS.AUTOMOVIL WHERE ID_AUTOMOVIL IN (101,102)
DELETE FROM USUARIOS.CONDUCTOR WHERE ID_USUARIO = 100
DELETE FROM USUARIOS.USUARIO WHERE ID_USUARIO = 100

BEGIN TRANSACTION TEST_TR_AUTO_FOR1_DISPONIBLE

	INSERT INTO USUARIOS.USUARIO
	VALUES (100, NULL, 1, 0, 0, 'Lorem4*', 'mooms', 'nanaMoom@example.com', 'Alan', 'Turing', NULL)
	
	insert into USUARIOS.conductor (ID_USUARIO, LICENCIA,VIGENCIA,DESCRIPCION,FOTO)
	select '100','1234ABCD','2025-05-25','descripción ingeniosa 4', *from OpenRowset(Bulk 'C:\Users\cmal1\Documents\Universidad\Semestre6\Bases de datos\proyectofinal\Appsafe\imag\Processing.png', Single_Blob) As ProductosFoto
	go

	INSERT INTO USUARIOS.AUTOMOVIL
	VALUES (102, 'A113PIXA', 2025, 100, 1, 1);
	SELECT * FROM USUARIOS.AUTOMOVIL

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_AUTO_FOR1_DISPONIBLE2

	INSERT INTO USUARIOS.USUARIO
	VALUES (100, NULL, 1, 0, 0, 'Lorem4*', 'mooms', 'nanaMoom@example.com', 'Alan', 'Turing', NULL)
	
	insert into USUARIOS.conductor (ID_USUARIO, LICENCIA,VIGENCIA,DESCRIPCION,FOTO)
	select '100','1234ABCD','2025-05-25','descripción ingeniosa 4', *from OpenRowset(Bulk 'C:\Users\cmal1\Documents\Universidad\Semestre6\Bases de datos\proyectofinal\Appsafe\imag\Processing.png', Single_Blob) As ProductosFoto
	go

	INSERT INTO USUARIOS.AUTOMOVIL
	VALUES (101, 'A1215468', 2025, 100, 1, 0),
	(102, 'A113PIXA', 2025, 100, 1, 0);

	UPDATE USUARIOS.AUTOMOVIL
	SET DISPONIBLE=1
	WHERE ID_AUTOMOVIL IN (101,102)

	UPDATE USUARIOS.AUTOMOVIL
	SET DISPONIBLE=1
	WHERE ID_AUTOMOVIL=101
	
	UPDATE USUARIOS.AUTOMOVIL
	SET DISPONIBLE=1
	WHERE ID_AUTOMOVIL=102

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_AUTO_FOR1_DISPONIBLE2

	INSERT INTO USUARIOS.USUARIO
	VALUES (100, NULL, 1, 0, 0, 'Lorem4*', 'mooms', 'nanaMoom@example.com', 'Alan', 'Turing', NULL)
	
	insert into USUARIOS.conductor (ID_USUARIO, LICENCIA,VIGENCIA,DESCRIPCION,FOTO)
	select '100','1234ABCD','2025-05-25','descripción ingeniosa 4', *from OpenRowset(Bulk 'C:\Users\cmal1\Documents\Universidad\Semestre6\Bases de datos\proyectofinal\Appsafe\imag\Processing.png', Single_Blob) As ProductosFoto
	go

	INSERT INTO USUARIOS.AUTOMOVIL
	VALUES (101, 'A1215468', 2025, 100, 1, 0),
	(102, 'A113PIXA', 2025, 100, 1, 0);

	UPDATE USUARIOS.AUTOMOVIL
	SET DISPONIBLE=1
	WHERE ID_AUTOMOVIL=101
	
	UPDATE USUARIOS.AUTOMOVIL
	SET DISPONIBLE=1
	WHERE ID_AUTOMOVIL=102

ROLLBACK TRANSACTION

-- TRIGGER UPDATE_VIAJE

BEGIN TRANSACTION TEST_UPDATE_VIAJE_NO_DISPONIBLE

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0);	

	SELECT * FROM USUARIOS.AUTOMOVIL
	WHERE ID_AUTOMOVIL=100

	INSERT INTO OPERACIONES.VIAJE
	VALUES 	(100, NULL, -99.120200, 19.508300, -99.133209, 19.432608, 331, 10, 0.00, 2, 2, 'Viaje caro y tardado.', 1, 1, 1, 1, NULL, 100, NULL);

	SELECT * FROM OPERACIONES.VIAJE
	WHERE ID_VIAJE=100

	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS = 3
	WHERE ID_VIAJE = 100
	
	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS = 9
	WHERE ID_VIAJE = 100
	
	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS = 5
	WHERE ID_VIAJE = 100

	SELECT * FROM OPERACIONES.VIAJE
	WHERE ID_VIAJE=100

	SELECT * FROM USUARIOS.AUTOMOVIL
	WHERE ID_AUTOMOVIL=100
ROLLBACK TRANSACTION

-- TRIGGER TR_PAGO_FOR1

BEGIN TRANSACTION TEST_TR_PAGO_FOR1_PAGO_SEMANAL

    INSERT INTO OPERACIONES.PAGO
    VALUES (4, 123, 112, '2025-05-20'),
        (4, 124, 358, '2025-05-21');

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_PAGO_FOR1_PAGO_SEMANAL

    INSERT INTO OPERACIONES.PAGO
    VALUES (4, 123, 112, '2025-08-20');

    SELECT *
    FROM OPERACIONES.PAGO
    WHERE ID_USUARIO=4

ROLLBACK TRANSACTION

-- TRIGGER .TR_

BEGIN TRANSACTION TEST_TR_REGISTRO_UBICACION

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0);	

	INSERT INTO OPERACIONES.VIAJE
	VALUES 	(100, NULL, -99.120200, 19.508300, -99.133209, 19.432608, 331, 10, 0.00, 2, 2, 'Viaje caro y tardado.', 1, 1, 1, 1, NULL, 100, NULL);

    INSERT INTO REGISTROS.REGISTRO_UBICACION (ID_REGISTRO_UBICACION,ID_VIAJE, Longitud, Latitud, Hora)
    VALUES (100,100, -99.1330, 19.4320, GETDATE());

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_REGISTRO_UBICACION

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0);	

	INSERT INTO OPERACIONES.VIAJE
	VALUES 	(100, NULL, -99.120200, 19.508300, -99.133209, 19.432608, 331, 10, 0.00, 2, 2, 'Viaje caro y tardado.', 1, 1, 1, 1, NULL, 100, NULL);

    INSERT INTO REGISTROS.REGISTRO_UBICACION (ID_REGISTRO_UBICACION,ID_VIAJE, Longitud, Latitud, Hora)
    VALUES (100,100, -99.1330, 19.4320, GETDATE());

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_REGISTRO_UBICACION_C

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0);	

	INSERT INTO OPERACIONES.VIAJE
	VALUES 	(100, NULL, -99.120200, 19.508300, -99.133209, 19.432608, 331, 10, 0.00, 2, 2, 'Viaje caro y tardado.', 1, 1, 1, 1, NULL, 100, NULL);

	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS=3
	WHERE ID_VIAJE=100

	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS=4
	WHERE ID_VIAJE=100

    INSERT INTO REGISTROS.REGISTRO_UBICACION (ID_REGISTRO_UBICACION,ID_VIAJE, Longitud, Latitud, Hora)
    VALUES (100,100, -99.1330, 19.4320, '2025-05-20 00:00:00'),
	(101,100, -99.1330, 19.4320, '2025-05-20 00:01:00'),
	(102,100, -99.1330, 19.4320, '2025-05-20 00:02:00')

	SELECT * FROM REGISTROS.REGISTRO_UBICACION
	WHERE ID_VIAJE=100

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_REGISTRO_UBICACION_F

    INSERT INTO USUARIOS.AUTOMOVIL
    VALUES (100, 'OUT4TIME', 2025, 4, 1, 0);	

	INSERT INTO OPERACIONES.VIAJE
	VALUES 	(100, NULL, -99.120200, 19.508300, -99.133209, 19.432608, 331, 10, 0.00, 2, 2, 'Viaje caro y tardado.', 1, 1, 1, 1, NULL, 100, NULL);

	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS=3
	WHERE ID_VIAJE=100

	UPDATE OPERACIONES.VIAJE
	SET ID_ESTATUS=4
	WHERE ID_VIAJE=100

    INSERT INTO REGISTROS.REGISTRO_UBICACION (ID_REGISTRO_UBICACION,ID_VIAJE, Longitud, Latitud, Hora)
    VALUES (100,100, -99.1330, 19.4320, '2025-05-20 00:00:00'),
		(101,100, -99.1330, 19.4320, '2025-05-20 00:00:00');


	SELECT * FROM REGISTROS.REGISTRO_UBICACION
	WHERE ID_VIAJE=100

ROLLBACK TRANSACTION


-- TRIGGER TR_TARJETA_FOR1
SELECT * FROM USUARIOS.TARJETA
BEGIN TRANSACTION TEST_TR_TARJETA_FOR1_CANTIDAD

    INSERT INTO USUARIOS.TARJETA
    VALUES (100, '2026-07-08', '0123456789023456', 1, 1),
        (101, '2026-07-08', '12345678901234567',1,1),
        (102, '2026-07-08', '123456789012345678',1,1);

ROLLBACK TRANSACTION

-- TRIGGER FechaInicioViaje

BEGIN TRANSACTION TEST_FechaInicioViaje

    INSERT INTO OPERACIONES.VIAJE
    VALUES (100, NULL, -99.1332, 19.4326, -99.1400, 19.4400, 0, NULL, NULL, NULL, NULL, NULL, 1, 1, 1, 1, NULL, NULL, NULL);
	
    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=3
    WHERE ID_VIAJE=100
	
	SELECT *
	FROM OPERACIONES.VIAJE
	WHERE ID_VIAJE=100

ROLLBACK TRANSACTION

-- TRIGGER TR_VIAJE_HORA

BEGIN TRANSACTION TEST_TR_VIAJE_HORA_PROGRAMADA

    INSERT INTO OPERACIONES.VIAJE
    VALUES (100, '2025-04-20 11:11:11', -99.1332, 19.4326, -99.1400, 19.4400, 0, NULL, NULL, NULL, NULL, NULL, 1, 5, 1, 1, NULL, NULL, NULL);

ROLLBACK TRANSACTION

--TRIGGER TR_VIAJE_CAMBIO_ESTATUS

BEGIN TRANSACTION TEST_TR_VIAJE_CAMBIO_ESTATUS

    INSERT INTO OPERACIONES.VIAJE
    VALUES (100, NULL, -99.1332, 19.4326, -99.1400, 19.4400, 0, NULL, NULL, NULL, NULL, NULL, 1, 1, 1, 1, NULL, NULL, NULL);

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=5
    WHERE ID_VIAJE=100

	SELECT *
	FROM REGISTROS.VIAJE_ESTATUS
	WHERE ID_VIAJE=100

ROLLBACK TRANSACTION

BEGIN TRANSACTION TEST_TR_CAMBIO_ESTATUS_CORRECTO

    INSERT INTO OPERACIONES.VIAJE
    VALUES (100, NULL, -99.1332, 19.4326, -99.1400, 19.4400, 0, NULL, NULL, NULL, NULL, NULL, 1, 1, 1, 1, NULL, NULL, NULL);

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=3
    WHERE ID_VIAJE=100

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=4
    WHERE ID_VIAJE=100

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=6
    WHERE ID_VIAJE=100

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=8
    WHERE ID_VIAJE=100

    UPDATE OPERACIONES.VIAJE
    SET ID_ESTATUS=5
    WHERE ID_VIAJE=100

	SELECT *
	FROM REGISTROS.VIAJE_ESTATUS
	WHERE ID_VIAJE=100

ROLLBACK TRANSACTION

-- TRIGGER TR_VIAJE_ESTATUS_INICIAL

BEGIN TRANSACTION TEST_TR_VIAJE_ESTATUS_INICIAL

    INSERT INTO OPERACIONES.VIAJE
    VALUES (100, NULL, -99.1332, 19.4326, -99.1400, 19.4400, 0, NULL, NULL, NULL, NULL, NULL, 1, 5, 1, 1, NULL, NULL, NULL);

ROLLBACK TRANSACTION

